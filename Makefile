# ============================================================================
# Makefile –¥–ª—è BuyWhyWhy (–ö—ç—à–∫–∞)
# ============================================================================
# –£–¥–æ–±–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   make setup     - –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
#   make up        - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
#   make down      - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
#   make logs      - –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏
#   make clean     - –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ (–≤–∫–ª—é—á–∞—è volumes)
#
# ============================================================================

.PHONY: help setup up down restart logs clean test backend-shell db-shell

# Default target
.DEFAULT_GOAL := help

# ============================================================================
# Help
# ============================================================================

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
	@echo "BuyWhyWhy (–ö—ç—à–∫–∞) - –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

# ============================================================================
# Setup
# ============================================================================

setup: ## –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
	@echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "‚úÖ –°–æ–∑–¥–∞–Ω .env —Ñ–∞–π–ª (–Ω–µ –∑–∞–±—É–¥—å—Ç–µ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ!)"; \
	else \
		echo "‚ö†Ô∏è  .env —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"; \
	fi
	@echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ backend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
	@cd backend && npm install
	@echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
	@echo ""
	@echo "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
	@echo "  1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã"
	@echo "  2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: make up"

# ============================================================================
# Docker Commands
# ============================================================================

up: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã (PostgreSQL + Backend)
	@echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
	docker-compose up -d
	@echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã!"
	@echo ""
	@echo "Backend: http://localhost:3000"
	@echo "Health check: curl http://localhost:3000/health"
	@echo ""
	@echo "PostgreSQL: localhost:5432"
	@echo "Database: buywhywhy"
	@echo ""
	@make ps

up-tools: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã + pgAdmin
	@echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ + pgAdmin..."
	docker-compose --profile tools up -d
	@echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã!"
	@echo ""
	@echo "pgAdmin: http://localhost:5050"
	@echo "  Email: admin@buywhywhy.local"
	@echo "  Password: admin"

down: ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
	@echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
	docker-compose down
	@echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

restart: ## –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
	@echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
	@make down
	@make up

ps: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
	@docker-compose ps

logs: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
	docker-compose logs -f

logs-backend: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ backend
	docker-compose logs -f backend

logs-db: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ PostgreSQL
	docker-compose logs -f postgres

# ============================================================================
# Shell Access
# ============================================================================

backend-shell: ## –û—Ç–∫—Ä—ã—Ç—å shell –≤ backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
	docker-compose exec backend sh

db-shell: ## –û—Ç–∫—Ä—ã—Ç—å psql –≤ PostgreSQL
	docker-compose exec postgres psql -U postgres -d buywhywhy

# ============================================================================
# Development
# ============================================================================

dev-backend: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å backend –ª–æ–∫–∞–ª—å–Ω–æ (—Å hot reload)
	@echo "üíª –ó–∞–ø—É—Å–∫ backend –≤ dev —Ä–µ–∂–∏–º–µ..."
	@cd backend && npm run dev

dev-db-only: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ PostgreSQL (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ backend)
	@echo "üóÑÔ∏è  –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ PostgreSQL..."
	docker-compose up postgres -d
	@echo "‚úÖ PostgreSQL –∑–∞–ø—É—â–µ–Ω –Ω–∞ localhost:5432"

# ============================================================================
# Database
# ============================================================================

db-reset: ## –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (‚ö†Ô∏è —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!)
	@echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î!"
	@read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ volumes..."; \
		docker-compose down -v; \
		echo "üöÄ –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ë–î..."; \
		docker-compose up postgres -d; \
		echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∞"; \
	else \
		echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"; \
	fi

db-seed: ## –ü—Ä–∏–º–µ–Ω–∏—Ç—å seed –¥–∞–Ω–Ω—ã–µ
	@echo "üå± –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ seed –¥–∞–Ω–Ω—ã—Ö..."
	docker-compose exec -T postgres psql -U postgres -d buywhywhy < database/seed_mcc_codes.sql
	docker-compose exec -T postgres psql -U postgres -d buywhywhy < database/seed_russian_banks.sql
	@echo "‚úÖ Seed –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"

# ============================================================================
# Testing
# ============================================================================

test: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å backend —Ç–µ—Å—Ç—ã
	@echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
	@cd backend && npm test

test-watch: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –≤ watch —Ä–µ–∂–∏–º–µ
	@cd backend && npm run test:watch

test-coverage: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å coverage
	@cd backend && npm test -- --coverage

# ============================================================================
# Building
# ============================================================================

build: ## –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑—ã
	@echo "üèóÔ∏è  –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤..."
	docker-compose build

build-prod: ## –°–æ–±—Ä–∞—Ç—å production Docker –æ–±—Ä–∞–∑
	@echo "üèóÔ∏è  –°–±–æ—Ä–∫–∞ production –æ–±—Ä–∞–∑–∞..."
	docker build --target production -t buywhywhy-backend:prod ./backend

# ============================================================================
# Cleanup
# ============================================================================

clean: ## –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ (Docker volumes, node_modules, logs)
	@echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ Docker volumes –∏ –¥–∞–Ω–Ω—ã–µ!"
	@read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo "üßπ –û—á–∏—Å—Ç–∫–∞..."; \
		docker-compose down -v; \
		rm -rf backend/node_modules; \
		rm -rf backend/dist; \
		rm -rf backend/logs; \
		echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"; \
	else \
		echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"; \
	fi

# ============================================================================
# Health Checks
# ============================================================================

health: ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
	@echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ health..."
	@echo ""
	@echo "Backend:"
	@curl -s http://localhost:3000/health | jq . || echo "‚ùå Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
	@echo ""
	@echo "PostgreSQL:"
	@docker-compose exec postgres pg_isready -U postgres || echo "‚ùå PostgreSQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
